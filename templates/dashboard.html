<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .chart-container {
            min-height: 400px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .error {
            color: #dc3545;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π</a>
            <div class="navbar-nav flex-row">
                <a class="nav-link me-3" href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                <a class="nav-link" href="/add">–î–æ–±–∞–≤–∏—Ç—å</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h3 class="mb-4">üìà –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–∫–ª–∞–º–∞—Ü–∏—è—Ö</h3>
                        
                        <!-- –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 id="total-complaints">0</h5>
                                        <small class="text-muted">–í—Å–µ–≥–æ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 id="new-complaints">0</h5>
                                        <small class="text-muted">–ù–æ–≤—ã—Ö</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 id="today-complaints">0</h5>
                                        <small class="text-muted">–°–µ–≥–æ–¥–Ω—è</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 id="top-reason-count">0</h5>
                                        <small class="text-muted" id="top-reason-text">–¢–æ–ø –ø—Ä–∏—á–∏–Ω–∞</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>–¢–æ–ø –ø—Ä–∏—á–∏–Ω –≤–æ–∑–≤—Ä–∞—Ç–æ–≤</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="top-reasons-chart" class="chart-container">
                                            <div class="loading">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                                </div>
                                                <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="live-stats">
                                            <div class="loading">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                                </div>
                                                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>–î–∏–Ω–∞–º–∏–∫–∞ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π –ø–æ –º–µ—Å—è—Ü–∞–º</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="monthly-trend-chart" class="chart-container">
                                            <div class="loading">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                                </div>
                                                <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>–†–µ–∫–ª–∞–º–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="products-chart" class="chart-container">
                                            <div class="loading">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                                </div>
                                                <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <button onclick="loadAllCharts()" class="btn btn-primary">
                                            <span id="refresh-icon">üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏
                                        </button>
                                        <button onclick="runETL()" class="btn btn-outline-primary ms-2">
                                            üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å ETL
                                        </button>
                                        <div class="mt-2">
                                            <small class="text-muted">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-update">-</span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
        function formatDateTime() {
            const now = new Date();
            return now.toLocaleString('ru-RU');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏
        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="error">
                    <div>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                    <small>${message}</small>
                    <button onclick="loadChart('${containerId.replace('-chart', '')}')" class="btn btn-sm btn-outline-danger mt-2">
                        –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                    </button>
                </div>
            `;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        function hideLoading(containerId) {
            const loading = document.querySelector(`#${containerId} .loading`);
            if (loading) {
                loading.style.display = 'none';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ —Ç–æ–ø –ø—Ä–∏—á–∏–Ω
        function loadTopReasonsChart() {
            const container = 'top-reasons-chart';
            
            fetch('/api/charts/top_reasons')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    hideLoading(container);
                    
                    // –ï—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∞—Å—å —Å—Ç—Ä–æ–∫–∞ JSON
                    if (typeof data === 'string') {
                        try {
                            data = JSON.parse(data);
                        } catch(e) {
                            throw new Error('Invalid JSON response');
                        }
                    }
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö
                    if (data.error) {
                        showError(container, data.error);
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å
                    if (!data.data || data.data.length === 0) {
                        document.getElementById(container).innerHTML = `
                            <div class="text-center text-muted py-5">
                                <h5>üìä –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h5>
                                <p>–î–æ–±–∞–≤—å—Ç–µ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–∏ –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ ETL</p>
                            </div>
                        `;
                        return;
                    }
                    
                    Plotly.newPlot(container, data.data, data.layout || {}, {responsive: true});
                })
                .catch(error => {
                    console.error('Error loading top reasons:', error);
                    showError(container, error.message);
                });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
        function loadMonthlyTrendChart() {
            const container = 'monthly-trend-chart';
            
            fetch('/api/charts/monthly_trend')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    hideLoading(container);
                    
                    if (typeof data === 'string') {
                        try {
                            data = JSON.parse(data);
                        } catch(e) {
                            throw new Error('Invalid JSON response');
                        }
                    }
                    
                    if (data.error) {
                        showError(container, data.error);
                        return;
                    }
                    
                    if (!data.data || data.data.length === 0) {
                        document.getElementById(container).innerHTML = `
                            <div class="text-center text-muted py-5">
                                <h5>üìà –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h5>
                                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –º–µ—Å—è—Ü–∞–º</p>
                            </div>
                        `;
                        return;
                    }
                    
                    Plotly.newPlot(container, data.data, data.layout || {}, {responsive: true});
                })
                .catch(error => {
                    console.error('Error loading monthly trend:', error);
                    showError(container, error.message);
                });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º
        function loadProductsChart() {
            const container = 'products-chart';
            
            fetch('/api/charts/products')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    hideLoading(container);
                    
                    if (typeof data === 'string') {
                        try {
                            data = JSON.parse(data);
                        } catch(e) {
                            throw new Error('Invalid JSON response');
                        }
                    }
                    
                    if (data.error) {
                        showError(container, data.error);
                        return;
                    }
                    
                    if (!data.data || data.data.length === 0) {
                        document.getElementById(container).innerHTML = `
                            <div class="text-center text-muted py-5">
                                <h5>üì¶ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h5>
                                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º</p>
                            </div>
                        `;
                        return;
                    }
                    
                    Plotly.newPlot(container, data.data, data.layout || {}, {responsive: true});
                })
                .catch(error => {
                    console.error('Error loading products chart:', error);
                    showError(container, error.message);
                });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function loadStats() {
            fetch('/api/stats')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                    document.getElementById('total-complaints').textContent = data.total_complaints || 0;
                    document.getElementById('new-complaints').textContent = data.new_complaints || 0;
                    document.getElementById('today-complaints').textContent = data.today_complaints || 0;
                    document.getElementById('top-reason-count').textContent = data.top_reason_count || 0;
                    document.getElementById('top-reason-text').textContent = data.top_reason || '–¢–æ–ø –ø—Ä–∏—á–∏–Ω–∞';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                    document.getElementById('live-stats').innerHTML = `
                        <div class="mb-3">
                            <strong>–í—Å–µ–≥–æ —Ä–µ–∫–ª–∞–º–∞—Ü–∏–π:</strong>
                            <span class="badge bg-primary float-end">${data.total_complaints || 0}</span>
                        </div>
                        <div class="mb-3">
                            <strong>–ù–æ–≤—ã—Ö:</strong>
                            <span class="badge bg-warning float-end">${data.new_complaints || 0}</span>
                        </div>
                        <div class="mb-3">
                            <strong>–†–µ—à–µ–Ω–æ:</strong>
                            <span class="badge bg-success float-end">${data.resolved_complaints || 0}</span>
                        </div>
                        <div class="mb-3">
                            <strong>–°–µ–≥–æ–¥–Ω—è:</strong>
                            <span class="badge bg-info float-end">${data.today_complaints || 0}</span>
                        </div>
                        <div>
                            <strong>–¢–æ–ø –ø—Ä–∏—á–∏–Ω–∞:</strong><br>
                            <small class="text-muted">${data.top_reason || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</small>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    document.getElementById('live-stats').innerHTML = `
                        <div class="text-danger">
                            <small>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</small>
                        </div>
                    `;
                });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
        function loadAllCharts() {
            const btn = document.querySelector('button[onclick="loadAllCharts()"]');
            const icon = document.getElementById('refresh-icon');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
            btn.disabled = true;
            icon.textContent = '‚è≥';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            loadStats();
            loadTopReasonsChart();
            loadMonthlyTrendChart();
            loadProductsChart();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            document.getElementById('last-update').textContent = formatDateTime();
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                btn.disabled = false;
                icon.textContent = 'üîÑ';
            }, 2000);
        }

        // –ó–∞–ø—É—Å–∫ ETL
        function runETL() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ –ó–∞–ø—É—Å–∫ ETL...';
            
            fetch('/run_etl', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message || 'ETL –≤—ã–ø–æ–ª–Ω–µ–Ω');
                    if (data.status === 'success') {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ—Å–ª–µ ETL
                        setTimeout(loadAllCharts, 1000);
                    }
                })
                .catch(error => {
                    alert('–û—à–∏–±–∫–∞: ' + error.message);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å ETL';
                });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadAllCharts();
            document.getElementById('last-update').textContent = formatDateTime();
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(loadStats, 30000);
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ Plotly
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });
    </script>
</body>
</html>